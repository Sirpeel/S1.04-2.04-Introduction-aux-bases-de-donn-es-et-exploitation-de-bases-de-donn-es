--Exercice 2

DROP TABLE IF EXISTS import;
CREATE temp TABLE import(
ID int,
name varchar(110),
sex char(1),
age int,
height int,
weight float,
team varchar(50),
noc char(3),
games char(11),
year int,
season char(6),
city varchar(30),
sport varchar(30),
event varchar(90),
medal varchar(6));

\copy import from athlete_events.csv with(format CSV,delimiter ',', NULL 'NA', HEADER);

DELETE from import
WHERE year<1920;

DELETE from import
WHERE  sport LIKE 'Art%';

Select Count(*)
FROM import;

DROP TABLE IF EXISTS import2;
CREATE temp TABLE import2(
NOC char(3),
region text,
notes text);
\copy import2  from noc_regions.csv with(format CSV,delimiter ',', NULL 'NA', HEADER);

update import2 set noc = 'SGP' where noc = 'SIN';

--Exercice 4
DROP TABLE IF EXISTS athlete CASCADE;
DROP TABLE IF EXISTS events CASCADE ;
DROP TABLE IF EXISTS regions CASCADE;
DROP TABLE IF EXISTS team CASCADE;
DROP TABLE IF EXISTS jo CASCADE;
DROP TABLE IF EXISTS resultat CASCADE;


CREATE TABLE athlete(
ano int,
CONSTRAINT pk_athlete PRIMARY KEY (ano));

CREATE TABLE events(
eno Serial,
ename varchar(90),
sport varchar(30),
CONSTRAINT pk_events PRIMARY KEY (eno));

CREATE TABLE regions(
NOC char(3),
region text,
notes text,
CONSTRAINT pk_regions PRIMARY KEY (NOC));

CREATE TABLE team(
tno Serial,
country varchar(50),
NOC char(3),
CONSTRAINT pk_team PRIMARY KEY (tno),
CONSTRAINT fk_team FOREIGN KEY (NOC) REFERENCES regions(NOC)
ON UPDATE CASCADE ON DELETE CASCADE);

CREATE TABLE jo(
gno Serial,
games char(11),
year int,
season char(6),
city varchar(30),
CONSTRAINT pk_jo PRIMARY KEY (gno));

CREATE TABLE resultat(
name varchar(110),
sex char(1),
age int,
height int,
weight float,
medal varchar(6),

eno Serial,
ano int,
gno Serial,
tno Serial,
CONSTRAINT pk_resultat PRIMARY KEY (eno,ano,gno,tno),
CONSTRAINT fk_resultat1 FOREIGN KEY (eno) REFERENCES events(eno)
ON UPDATE CASCADE ON DELETE CASCADE,
CONSTRAINT fk_resultat2 FOREIGN KEY (ano) REFERENCES athlete(ano)
ON UPDATE CASCADE ON DELETE CASCADE,
CONSTRAINT fk_resultat3 FOREIGN KEY (gno) REFERENCES jo(gno)
ON UPDATE CASCADE ON DELETE CASCADE,
CONSTRAINT fk_resultat4 FOREIGN KEY (tno) REFERENCES team(tno)
ON UPDATE CASCADE ON DELETE CASCADE
);

INSERT INTO events(ename,sport)
       Select DISTINCT i.event,i.sport
       FROM import AS i;

INSERT INTO athlete(ano)
       Select DISTINCT i.ID
       FROM import AS i;

INSERT INTO regions(NOC,region,notes)
       Select i1.NOC,i1.region,i1.notes
       FROM import2 AS i1;

INSERT INTO team(NOC, country)
       Select DISTINCT i.noc, i.team
       FROM import AS i;

INSERT INTO jo(games,year,season,city)
       SELECT DISTINCT i.games,i.year,i.season,i.city
       FROM import AS i;
       
INSERT INTO resultat(name, sex, age, height, weight, medal, eno, ano, gno, tno)
       SELECT i.name, i.sex, i.age, i.height, i.weight, i.medal, e.eno, i.ID,j.gno,t.tno
       FROM import AS i
       INNER JOIN events AS e ON e.ename = i.event AND e.sport = i.sport
       INNER JOIN team AS t ON t.country=i.team AND t.NOC=i.noc
       INNER JOIN jo AS j ON j.games=i.games AND j.year=i.year AND j.season=i.season AND j.city=i.city;
